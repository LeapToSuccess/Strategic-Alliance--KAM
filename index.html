<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Alliance Scoreboard (Live)</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons Library (Loads globally as 'lucide') -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Custom styles for better visibility and layout */
        body { font-family: 'Inter', sans-serif; }
        .tab-content { min-height: 500px; }
        .tab-button {
            transition: all 0.2s ease;
        }
        /* Custom RAG classes for better visibility */
        .rag-green { background-color: #C6EFCE; color: #006100; border-color: #A3D4AA; }
        .rag-yellow { background-color: #FFEB9C; color: #7F6000; border-color: #FFDDAA; }
        .rag-red { background-color: #FFC7CE; color: #9C0006; border-color: #FFAAAA; }
        .rag-bar-green { background-color: #10B981; }
        .rag-bar-yellow { background-color: #F59E0B; }
        .rag-bar-red { background-color: #D82C2C; }
    </style>
    <script type="module">
        // --- Import Firebase SDKs ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            setPersistence, 
            browserLocalPersistence 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            onSnapshot, 
            addDoc, 
            setDoc, 
            deleteDoc,
            setLogLevel,
            getDoc,
            getDocs,
            query as firestoreQuery
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL CONFIGURATION AND INITIAL DATA ---
        // Accessing global variables provided by the canvas environment
        const __app_id = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
        const __firebase_config = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : null;
        const __initial_auth_token = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;
        
        const LEAP_COLORS = {
            BLUE: '#0078B5',
            RED: '#D82C2C',
            GREY: '#4D4D4D',
        };

        const PILLARS = ["Product", "Delivery", "Service", "Relationship"];
        const TEAMS = ["Team A", "Team B", "Team C", "Team D"];
        const LOW_SCORE_THRESHOLD = 3.5;
        const PUBLIC_DATA_PATH = `/artifacts/${__app_id}/public/data`;
        const PRIVATE_DATA_PATH = (uid) => `/artifacts/${__app_id}/users/${uid}/private`;

        const initialWeights = { Product: 0.20, Delivery: 0.25, Service: 0.25, Relationship: 0.30 };
        const initialScoresTemplate = PILLARS.flatMap(pillar => 
            ['Communicate value', 'Route feedback', 'Share roadmap', 'Pre-empt risks', 'Review SLAs', 'Close escalations', 'Own problems', 'Offer solutions', 'Acknowledge emotions', 'Map stakeholders', 'Hold QBRs', 'Co-create value']
            .filter((_, i) => PILLARS.indexOf(pillar) * 3 <= i && i < (PILLARS.indexOf(pillar) + 1) * 3)
            .map(behavior => ({ pillar, behavior, score: 3 }))
        ).slice(0, 12);

        const initialTeamData = (teamName) => ({
            teamName: teamName,
            evidenceFactor: 1.0,
            behaviorScores: initialScoresTemplate.map(item => ({...item, score: 3})),
        });

        // --- GLOBAL STATE ---
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;
        let userRole = 'Trainer'; // <-- DEFAULTED TO TRAINER TO BYPASS MODAL
        let weights = initialWeights;
        let allTeamData = {};
        let ledgerItems = [];
        let llmStatus = { isLoading: false, error: null, message: null, targetPillar: null };
        let activeTab = 'Leaderboard';
        
        // --- UTILITY FUNCTIONS ---
        const getIsTrainer = () => userRole === 'Trainer';
        const getUserTeam = () => getIsTrainer() ? null : userRole; 

        const getRagClass = (score) => {
            if (score >= 80) return "rag-green";
            if (score >= 60) return "rag-yellow";
            return "rag-red";
        };
        const getRagBarClass = (score) => {
            if (score >= 80) return "rag-bar-green";
            if (score >= 60) return "rag-bar-yellow";
            return "rag-bar-red";
        };

        const generateUniqueId = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 5);

        // --- CORE CALCULATIONS (LEADERBOARD) ---
        const calculateLeaderboardData = () => {
            const teamScores = {};
            const teamRadarData = {};
            const allTeamKeys = Object.keys(allTeamData);

            // 1. Calculate Radar Data (Pillar Averages)
            allTeamKeys.forEach(team => {
                const teamData = allTeamData[team];
                teamRadarData[team] = {};
                
                PILLARS.forEach(pillar => {
                    const pillarScores = teamData.behaviorScores
                        .filter(item => item.pillar === pillar)
                        .map(item => item.score);
                    
                    const average = pillarScores.length > 0
                        ? pillarScores.reduce((sum, score) => sum + score, 0) / pillarScores.length
                        : 0;

                    teamRadarData[team][pillar] = average;
                });
            });

            // 2. Calculate Account Health (SUMPRODUCT equivalent)
            allTeamKeys.forEach(team => {
                let sumproduct = 0;
                PILLARS.forEach(pillar => {
                    sumproduct += weights[pillar] * (teamRadarData[team][pillar] || 0);
                });

                // Final Account Health Score (ROUND(20 * SUMPRODUCT * EvidenceFactor, 0))
                const evidenceFactor = allTeamData[team]?.evidenceFactor || 1.0;
                const score = Math.round(20 * sumproduct * evidenceFactor);
                teamScores[team] = score;
            });

            // 3. Calculate Rank (RANK.EQ equivalent)
            const scoresArray = Object.entries(teamScores).map(([team, score]) => ({ team, score }));
            const sortedScores = [...scoresArray].sort((a, b) => b.score - a.score);

            const leaderboard = scoresArray.map(item => {
                // Find rank by finding the first index of a score greater than or equal to current score
                const rank = sortedScores.findIndex(s => s.score === item.score) + 1;
                return {
                    team: item.team,
                    score: item.score,
                    evidenceFactor: allTeamData[item.team]?.evidenceFactor || 1.0,
                    rank: rank,
                    radar: teamRadarData[item.team],
                };
            });

            // 4. Sort by Rank
            leaderboard.sort((a, b) => a.rank - b.rank);

            return { leaderboard };
        };

        // --- LLM (GEMINI) LOGIC ---

        const generateImprovementPlan = async (pillar, lowScores) => {
            if (llmStatus.isLoading) return;
            llmStatus = { isLoading: true, error: null, message: `Generating plan for ${pillar}...` };
            renderApp();

            const prompt = `Act as a Strategic Performance Coach for a B2B alliance team. The team is scoring low in the "${pillar}" pillar, specifically on these behaviors (score is 1-5, 5 is best): ${JSON.stringify(lowScores)}. Your goal is to provide a plan to improve. Based ONLY on the provided scores and pillar focus:
            1. Summarize the core weakness in one sentence.
            2. Provide exactly 3 actionable, specific improvement tasks.
            3. For each task, define a relevant Key Performance Indicator (KPI) and a Target Timeline (30 days, 60 days, etc.).
            
            Return the result as a JSON array of objects, structured by the responseSchema provided.`;

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "You are a concise, action-oriented business coach. Focus on measurable outcomes." }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "area": { "type": "STRING", "description": "The strategic pillar (e.g., Product, Service)." },
                                "action": { "type": "STRING", "description": "The specific task to be performed." },
                                "kpi": { "type": "STRING", "description": "The measurable outcome (e.g., 'Increase feedback routes by 50%')." },
                                "timeline": { "type": "STRING", "description": "The target duration (e.g., 30 days)." },
                            },
                            "required": ["area", "action", "kpi", "timeline"]
                        }
                    }
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                const jsonString = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonString) throw new Error("LLM returned empty or invalid response.");
                
                let plan = JSON.parse(jsonString);

                // Add to ledger
                for (const item of plan) {
                    await handleLedgerAdd(item.area, item.action, item.kpi, item.timeline);
                }

                llmStatus = { 
                    isLoading: false, 
                    message: `✅ Plan added to Ledger for ${pillar}!`, 
                    targetPillar: pillar 
                };
                
            } catch (e) {
                console.error("Gemini API Error:", e);
                llmStatus = { isLoading: false, error: "Failed to generate plan. Check console.", targetPillar: pillar };
            }
            renderApp();
        };

        // --- FIREBASE WRITE OPERATIONS (Mutators) ---

        const handleTeamClaim = async (role) => {
            // NOTE: This function is currently disabled in the UI but retained for future use.
            // Role is set globally upon initialization.
            if (!db || !userId) return;
            userRole = role; 
            
            try {
                const userRoleRef = doc(db, PRIVATE_DATA_PATH(userId), 'role_claim');
                await setDoc(userRoleRef, { role: role, claimedAt: new Date().toISOString() });
            } catch (e) {
                console.error("Error claiming role:", e);
            }
            renderApp();
        };

        const handleScoreChange = async (team, index, newScore) => {
            if (!db || getUserTeam() !== team || getIsTrainer()) return; 

            const teamRef = doc(db, `${PUBLIC_DATA_PATH}/team_inputs`, team);
            const currentData = allTeamData[team];
            
            const updatedScores = currentData.behaviorScores.map((item, i) => 
                i === index ? { ...item, score: newScore } : item
            );
            
            try {
                await setDoc(teamRef, { 
                    ...currentData, 
                    behaviorScores: updatedScores 
                });
            } catch (e) {
                console.error("Error updating score:", e);
            }
        };

        const handleWeightChange = async (pillar, newWeight) => {
            // Since we defaulted to Trainer, we allow editing here temporarily for testing
            if (!db) return; 
            const configRef = doc(db, `${PUBLIC_DATA_PATH}/scoreboard_config`, 'weights');
            const newWeights = { ...weights, [pillar]: newWeight };
            try {
                await setDoc(configRef, { weights: newWeights });
            } catch (e) {
                console.error("Error updating weights:", e);
            }
        };

        const handleEvidenceFactorChange = async (team, newFactor) => {
            if (!db || getUserTeam() !== team || getIsTrainer()) return;

            const teamRef = doc(db, `${PUBLIC_DATA_PATH}/team_inputs`, team);
            const currentData = allTeamData[team];

            try {
                await setDoc(teamRef, { 
                    ...currentData,
                    evidenceFactor: parseFloat(newFactor) || 0
                });
            } catch (e) {
                console.error("Error updating evidence factor:", e);
            }
        };

        // --- Ledger Handlers ---

        const handleLedgerEdit = async (id, field, value) => {
            if (!db || !userRole) return; // Trainer or Team can edit ledger
            const itemRef = doc(db, `${PUBLIC_DATA_PATH}/alliance_ledger`, id);
            try {
                await setDoc(itemRef, { [field]: value, owner: userRole }, { merge: true });
            } catch (e) {
                console.error("Error updating ledger item:", e);
            }
        };

        const handleLedgerAdd = async (area = 'New Commitment', action = 'Enter commitment here', kpi = 'Define success metric', timeline = '30 days') => {
            if (!db || !userRole) return; 
            const newCommitment = {
                area: area,
                action: action,
                owner: getUserTeam() || userRole, // Use Trainer or the Team
                kpi: kpi,
                timeline: timeline,
                proof: '',
            };
            try {
                await addDoc(collection(db, `${PUBLIC_DATA_PATH}/alliance_ledger`), newCommitment);
            } catch (e) {
                console.error("Error adding ledger item:", e);
            }
        };

        const handleLedgerDelete = async (id) => {
            if (!db || !userRole) return;
            try {
                await deleteDoc(doc(db, `${PUBLIC_DATA_PATH}/alliance_ledger`, id));
            } catch (e) {
                console.error("Error deleting ledger item:", e);
            }
        };

        // --- RENDER FUNCTIONS ---

        const renderUserStatus = () => {
            const container = document.getElementById('user-status');
            if (!container) return;

            if (!isAuthReady) {
                container.innerHTML = `<span class="text-sm text-gray-500">Connecting...</span>`;
                return;
            }

            // Since userRole is defaulted to 'Trainer', this will always run now
            const roleDisplay = getIsTrainer() ? 
                `<span class="font-extrabold" style="color:${LEAP_COLORS.RED}">${userRole} (Read-Only)</span>` : 
                `<span class="font-extrabold" style="color:${LEAP_COLORS.RED}">${userRole}</span>`;

            container.innerHTML = `
                <span class="text-white text-sm">
                    Logged in as: ${roleDisplay}
                    <span class="font-mono text-xs text-gray-300 ml-2">ID: ${userId}</span>
                </span>
            `;
        };

        // NOTE: This function and its associated modal are now functionally bypassed.
        const renderTeamSelectionModal = () => {
            const modal = document.getElementById('team-selection-modal');
            if (modal) modal.classList.add('hidden');
        };

        const renderLeaderboard = () => {
            const container = document.getElementById('leaderboard-content');
            if (!container) return;
            
            const { leaderboard } = calculateLeaderboardData();

            const leaderboardHtml = leaderboard.map(team => {
                const ragClass = getRagClass(team.score);
                const ragBarClass = getRagBarClass(team.score);
                const widthPercentage = `${Math.min(100, team.score)}%`;

                // Determine if Evidence Factor is editable (Only by the claimed team, and not if Trainer)
                const isEvidenceEditable = getUserTeam() === team.team && !getIsTrainer();

                return `
                    <div class="border-b pb-4 last:pb-0 last:border-b-0">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-semibold text-gray-800">${team.team}</h3>
                            <div class="flex items-center space-x-4">
                                <label class="text-sm font-medium text-gray-600">Evidence Factor (0-1):</label>
                                <input
                                    type="number"
                                    min="0"
                                    max="1"
                                    step="0.1"
                                    value="${team.evidenceFactor}"
                                    data-team="${team.team}"
                                    data-type="evidence"
                                    onchange="window.app.handleEvidenceFactorChange(this.dataset.team, this.value)"
                                    class="w-20 p-2 border-2 rounded-lg text-center font-mono focus:ring-4 transition ${!isEvidenceEditable ? 'bg-gray-100 opacity-70 cursor-not-allowed' : ''}"
                                    style="border-color: ${LEAP_COLORS.BLUE};"
                                    ${!isEvidenceEditable ? 'disabled' : ''}
                                />
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 py-1">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-white shadow-md" style="background-color: ${LEAP_COLORS.BLUE};">
                                ${team.rank}
                            </div>
                            <div class="flex-grow bg-gray-200 rounded-full h-3">
                                <div 
                                    class="h-3 rounded-full transition-all duration-700 ease-out shadow-inner ${ragBarClass}" 
                                    style="width: ${widthPercentage};"
                                ></div>
                            </div>
                            <span class="w-12 text-center font-bold text-lg p-1 rounded-lg border ${ragClass}">${team.score}</span>
                        </div>
                    </div>
                `;
            }).join('');

            const radarHtml = leaderboard.map(team => `
                <div class="p-4 border border-gray-200 rounded-xl shadow-inner">
                    <h4 class="text-lg font-bold mb-3" style="color: ${LEAP_COLORS.GREY};">${team.team} Averages</h4>
                    ${PILLARS.map(pillar => `
                        <div class="mb-2">
                            <p class="text-sm font-medium">${pillar} Excellence:</p>
                            <div class="flex items-center space-x-2">
                                <div class="flex-grow bg-gray-100 rounded-full h-2.5">
                                    <div 
                                        class="h-2.5 rounded-full transition-all duration-500" 
                                        style="width: ${((team.radar[pillar] || 0) / 5) * 100}%; background-color: ${LEAP_COLORS.BLUE};"
                                    ></div>
                                </div>
                                <span class="text-xs font-semibold" style="color: ${LEAP_COLORS.BLUE};">${(team.radar[pillar] || 0).toFixed(2)}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');


            container.innerHTML = `
                <div class="p-4 space-y-8">
                    <div class="bg-white shadow-xl rounded-2xl p-6">
                        <h2 class="text-2xl font-extrabold mb-4" style="color: ${LEAP_COLORS.BLUE};">
                            <i data-lucide="award" class="h-6 w-6 mb-1 mr-2 inline"></i>Strategic Alliance Leaderboard
                        </h2>
                        <div class="space-y-4">
                            ${leaderboardHtml}
                        </div>
                    </div>
                    
                    <div class="bg-white shadow-xl rounded-2xl p-6">
                        <h2 class="text-2xl font-extrabold mb-4" style="color: ${LEAP_COLORS.BLUE};">
                            <i data-lucide="zap" class="h-6 w-6 mb-1 mr-2 inline"></i>Pillar Radar Data (Averages)
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            ${radarHtml}
                        </div>
                    </div>
                </div>
            `;
            // Initialize lucide icons for this content
            lucide.createIcons();
        };

        const renderBehaviors = () => {
            const container = document.getElementById('behaviors-content');
            if (!container) return;

            const userTeam = getUserTeam();
            const isEditable = !getIsTrainer() && userTeam;
            
            const teamData = allTeamData[userTeam] || initialTeamData(userTeam || 'Team A');

            // Calculate pillar averages for LLM button logic
            const pillarAverages = {};
            PILLARS.forEach(pillar => {
                const pillarScores = teamData.behaviorScores
                    .filter(item => item.pillar === pillar)
                    .map(item => item.score);
                pillarAverages[pillar] = pillarScores.length > 0
                    ? pillarScores.reduce((sum, score) => sum + score, 0) / pillarScores.length
                    : 0;
            });

            const llmButtons = PILLARS.map(pillar => {
                const avg = pillarAverages[pillar];
                // Trainer cannot generate plans, only view
                if (avg < LOW_SCORE_THRESHOLD && userTeam && !getIsTrainer()) { 
                    const lowScores = teamData.behaviorScores
                        .filter(item => item.pillar === pillar)
                        .map(item => ({ behavior: item.behavior, score: item.score }));

                    const isTarget = llmStatus.targetPillar === pillar;
                    const buttonText = isTarget && llmStatus.isLoading ? 
                        `<i data-lucide="loader-2" class="h-5 w-5 mr-2 inline animate-spin"></i> Generating Plan...` :
                        `✨ Generate Improvement Plan for ${pillar} (${avg.toFixed(2)})`;
                    
                    const buttonClass = isTarget && llmStatus.isLoading ? 
                        `bg-gray-500 hover:bg-gray-600 cursor-wait` : 
                        `bg-red-500 hover:bg-red-600 transition`;

                    return `
                        <div class="p-3 bg-red-50 rounded-lg shadow-inner flex justify-between items-center mb-3">
                            <p class="text-sm font-semibold text-red-700">LOW SCORE ALERT: ${pillar} average is below ${LOW_SCORE_THRESHOLD}.</p>
                            <button
                                onclick="window.app.generateImprovementPlanWrapper('${pillar}', ${JSON.stringify(lowScores).replace(/"/g, '&quot;')})"
                                class="flex items-center px-3 py-2 text-sm font-semibold rounded-lg text-white shadow-md ${buttonClass}"
                                style="background-color: ${isTarget && llmStatus.isLoading ? '#6B7280' : LEAP_COLORS.RED};"
                                ${llmStatus.isLoading ? 'disabled' : ''}
                            >
                                ${buttonText}
                            </button>
                        </div>
                    `;
                }
                return '';
            }).join('');
            
            const teamHeaderHtml = TEAMS.map(team => `
                <th key="${team}" class="px-4 py-3 text-center text-xs font-medium text-white uppercase tracking-wider">${team}</th>
            `).join('');

            const scoreInputHtml = teamData.behaviorScores.map((item, index) => {
                const rowClass = index % 3 === 0 ? `border-t-2 border-dashed` : '';
                return `
                    <tr key="${index}" class="hover:bg-blue-50 transition ${rowClass}" style="border-color: ${LEAP_COLORS.BLUE};">
                        <td class="px-6 py-3 whitespace-nowrap font-semibold ${index % 3 === 0 ? 'text-gray-900' : 'text-gray-500'}">
                            ${item.pillar}
                        </td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-700">
                            ${item.behavior}
                        </td>
                        ${TEAMS.map(team => {
                            const teamScores = allTeamData[team]?.behaviorScores || initialTeamData(team).behaviorScores;
                            const score = teamScores.find(scoreItem => 
                                scoreItem.pillar === item.pillar && scoreItem.behavior === item.behavior
                            )?.score || 3;
                            const isEditableForTeam = team === userTeam && isEditable;
                            
                            return `
                                <td key="${team}" class="px-4 py-2 whitespace-nowrap text-sm text-center">
                                    <select
                                        value="${score}"
                                        onchange="window.app.handleScoreChange('${team}', ${index}, parseInt(this.value, 10))"
                                        class="w-16 p-1 text-center border-2 rounded-lg cursor-pointer bg-white text-gray-800 focus:ring-4 transition ${!isEditableForTeam ? 'opacity-50 cursor-not-allowed bg-gray-100' : 'focus:ring-blue-300'}"
                                        style="border-color: ${isEditableForTeam ? LEAP_COLORS.BLUE : '#ccc'};"
                                        ${!isEditableForTeam ? 'disabled' : ''}
                                    >
                                        ${[1, 2, 3, 4, 5].map(val => `<option value="${val}">${val}</option>`).join('')}
                                    </select>
                                </td>
                            `;
                        }).join('')}
                    </tr>
                `;
            }).join('');


            container.innerHTML = `
                <div class="p-4">
                    <h2 class="text-2xl font-extrabold mb-6" style="color: ${LEAP_COLORS.BLUE};">
                        <i data-lucide="cpu" class="h-6 w-6 mb-1 mr-2 inline"></i>Behavior Scores (1–5) by Pillar and Team
                    </h2>

                    ${userTeam && !getIsTrainer() ? llmButtons : `
                        <div class="bg-gray-200 border border-gray-400 text-gray-700 px-4 py-3 rounded-xl mb-4 text-center font-semibold">
                            You are viewing the consolidated scores. Only your claimed team can edit its own scores and trigger the AI coach.
                        </div>
                    `}

                    ${llmStatus.error ? `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mb-4">${llmStatus.error}</div>` : ''}
                    ${llmStatus.message && !llmStatus.error ? `<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-xl mb-4">${llmStatus.message}</div>` : ''}

                    <div class="overflow-x-auto bg-white rounded-2xl shadow-xl">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="sticky top-0 shadow-sm" style="background-color: ${LEAP_COLORS.BLUE};">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Pillar</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Behavior</th>
                                    ${teamHeaderHtml}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-100">
                                ${scoreInputHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            lucide.createIcons();
        };

        const renderSettings = () => {
            const container = document.getElementById('settings-content');
            if (!container) return;

            const isEditable = getIsTrainer();
            const currentTotal = PILLARS.reduce((sum, p) => sum + (weights[p] || 0), 0);
            const isTotalValid = Math.abs(currentTotal - 1.0) < 0.001;
            const totalColor = isTotalValid ? 'text-green-600' : 'text-red-600';

            const weightsHtml = PILLARS.map(pillar => `
                <div key="${pillar}" class="flex justify-between items-center py-3 border-b border-gray-100">
                    <span class="text-lg font-medium text-gray-700">${pillar}</span>
                    <input
                        type="number"
                        min="0"
                        max="1"
                        step="0.05"
                        value="${weights[pillar]}"
                        onchange="window.app.handleWeightChange('${pillar}', parseFloat(this.value) || 0)"
                        class="w-24 p-2 border-2 rounded-lg text-center font-mono focus:ring-4 transition ${!isEditable ? 'bg-gray-100 opacity-70 cursor-not-allowed' : ''}"
                        style="border-color: ${LEAP_COLORS.BLUE};"
                        ${!isEditable ? 'disabled' : ''}
                    />
                </div>
            `).join('');

            container.innerHTML = `
                <div class="p-4 space-y-6">
                    <h2 class="text-2xl font-extrabold mb-4" style="color: ${LEAP_COLORS.BLUE};">
                        <i data-lucide="layers" class="h-6 w-6 mb-1 mr-2 inline"></i>Pillar Weights (must total 1.00)
                    </h2>
                    
                    ${!isEditable ? `
                        <div class="bg-gray-200 border border-gray-400 text-gray-700 px-4 py-3 rounded-xl text-center font-semibold">
                            You are logged in as Trainer (Read-Only). Weights cannot be edited.
                        </div>
                    ` : ''}

                    <div class="bg-white shadow-xl rounded-2xl p-6 max-w-lg mx-auto">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b-2" style="border-color: ${LEAP_COLORS.BLUE};">
                            <span class="font-bold text-lg text-gray-800">Pillar</span>
                            <span class="font-bold text-lg text-gray-800">Weight</span>
                        </div>
                        ${weightsHtml}
                        <div class="mt-6 pt-4 border-t-2 flex justify-between items-center">
                            <span class="font-bold text-xl text-gray-800">Total:</span>
                            <span class="font-extrabold text-2xl ${totalColor}">${currentTotal.toFixed(2)}</span>
                        </div>
                        <p class="mt-4 text-sm italic" style="color: ${LEAP_COLORS.GREY};">Adjust the weights to change the scoring model. Total must be 1.00 for accurate scores.</p>
                    </div>
                </div>
            `;
            lucide.createIcons();
        };

        const renderAllianceLedger = () => {
            const container = document.getElementById('ledger-content');
            if (!container) return;
            
            const tableRows = ledgerItems.map(item => `
                <tr class="hover:bg-blue-50 transition">
                    ${['area', 'action', 'owner', 'kpi', 'timeline', 'proof'].map(field => `
                        <td class="px-4 py-3 text-sm text-gray-700">
                            <input
                                type="text"
                                value="${item[field] || ''}"
                                onchange="window.app.handleLedgerEdit('${item.id}', '${field}', this.value)"
                                class="w-full p-1 border-b border-gray-300 focus:border-blue-500 bg-transparent text-sm"
                            />
                        </td>
                    `).join('')}
                    <td class="px-4 py-3 text-sm text-center">
                        <button
                            onclick="window.app.handleLedgerDelete('${item.id}')"
                            class="text-red-600 hover:text-red-800 transition p-1 rounded-full hover:bg-red-100"
                            title="Delete Commitment"
                        >
                            <i data-lucide="trash-2" class="h-4 w-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            container.innerHTML = `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-extrabold" style="color: ${LEAP_COLORS.BLUE};">
                            <i data-lucide="trending-up" class="h-6 w-6 mb-1 mr-2 inline"></i>Alliance Ledger (30-day Commitments)
                        </h2>
                        <button
                            onclick="window.app.handleLedgerAdd()"
                            class="flex items-center px-4 py-2 text-sm font-semibold rounded-lg text-white transition duration-300 shadow-md hover:shadow-lg"
                            style="background-color: ${LEAP_COLORS.BLUE};"
                        >
                            <i data-lucide="plus-circle" class="h-5 w-5 mr-2"></i>
                            Add New Commitment
                        </button>
                    </div>

                    <div class="overflow-x-auto bg-white rounded-2xl shadow-xl">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="sticky top-0 shadow-sm" style="background-color: ${LEAP_COLORS.BLUE};">
                                <tr>
                                    ${['Area', 'Action', 'Owner', 'KPI', 'Timeline', 'Proof', 'Actions'].map(header => `
                                        <th key="${header}" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                                            ${header}
                                        </th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-100">
                                ${tableRows}
                            </tbody>
                        </table>
                        ${ledgerItems.length === 0 ? '<p class="p-6 text-center text-gray-500 italic">No commitments recorded. Click "Add New Commitment" to start tracking!</p>' : ''}
                    </div>
                    <p class="p-4 text-sm italic" style="color: ${LEAP_COLORS.GREY};">
                        This ledger tracks team commitments to improve pillar scores. Edit fields directly to update records.
                    </p>
                </div>
            `;
            lucide.createIcons();
        };

        const renderApp = () => {
            renderUserStatus();
            // Modal is intentionally bypassed for troubleshooting
            renderTeamSelectionModal(); 

            // Since userRole is defaulted to Trainer, the app proceeds immediately
            const container = document.getElementById('main-content');
            if (!container) return;

            // Render navigation tabs
            const navItems = [
                { name: 'Leaderboard', id: 'leaderboard-content', icon: 'award' },
                { name: 'Behaviors', id: 'behaviors-content', icon: 'cpu' },
                { name: 'Settings', id: 'settings-content', icon: 'layers' },
                { name: 'Alliance Ledger', id: 'ledger-content', icon: 'trending-up' },
            ];

            const navHtml = navItems.map(item => `
                <button
                    onclick="window.app.setActiveTab('${item.name}')"
                    class="flex items-center px-3 py-2 text-sm font-medium rounded-t-lg transition-all duration-300 tab-button ${
                        activeTab === item.name
                          ? 'shadow-lg border-b-4 text-gray-900 bg-gray-100'
                          : 'text-gray-500 hover:text-gray-900 hover:bg-gray-50'
                    }"
                    style="${activeTab === item.name ? `border-color: ${LEAP_COLORS.BLUE};` : ''}"
                >
                    <i data-lucide="${item.icon}" class="h-5 w-5 mr-1 sm:mr-2"></i>
                    ${item.name}
                </button>
            `).join('');

            document.getElementById('nav-tabs').innerHTML = navHtml;
            
            // Hide all content areas
            navItems.forEach(item => {
                const element = document.getElementById(item.id);
                if (element) element.classList.add('hidden');
            });

            // Show active content area
            const activeElement = document.getElementById(navItems.find(item => item.name === activeTab)?.id);
            if (activeElement) {
                activeElement.classList.remove('hidden');
            }

            // Render content for the active tab
            switch (activeTab) {
                case 'Leaderboard': return renderLeaderboard();
                case 'Behaviors': return renderBehaviors();
                case 'Settings': return renderSettings();
                case 'Alliance Ledger': return renderAllianceLedger();
            }
            lucide.createIcons();
        };

        // --- FIREBASE INITIALIZATION AND LISTENERS ---

        const seedInitialData = async () => {
            if (!db) return;
            try {
                // 1. Weights
                const configRef = doc(db, `${PUBLIC_DATA_PATH}/scoreboard_config`, 'weights');
                const docSnap = await getDoc(configRef);
                if (!docSnap.exists()) {
                    await setDoc(configRef, { weights: initialWeights });
                }

                // 2. Team Inputs
                const teamCollectionRef = collection(db, `${PUBLIC_DATA_PATH}/team_inputs`);
                const teamSnap = await getDocs(teamCollectionRef);
                if (teamSnap.empty) {
                    TEAMS.forEach(async (team) => {
                        await setDoc(doc(teamCollectionRef, team), initialTeamData(team));
                    });
                }
            } catch (error) {
                console.error("Error seeding initial data:", error);
            }
        };

        const subscribeToData = () => {
            if (!db || !isAuthReady) return () => {};

            // 1. Subscribe to User Role (Private Data)
            // NOTE: We don't need the local userRole subscribe since we default it now, 
            // but we keep the other public data listeners.
            
            // 2. Subscribe to Weights (Public Data)
            const configRef = doc(db, `${PUBLIC_DATA_PATH}/scoreboard_config`, 'weights');
            const unsubscribeWeights = onSnapshot(configRef, (docSnap) => {
                if (docSnap.exists()) {
                    weights = docSnap.data().weights;
                }
                renderApp();
            });

            // 3. Subscribe to All Team Data (Public Data)
            const teamCollectionRef = collection(db, `${PUBLIC_DATA_PATH}/team_inputs`);
            const unsubscribeTeams = onSnapshot(teamCollectionRef, (snapshot) => {
                const teamDataMap = {};
                snapshot.docs.forEach(doc => {
                    teamDataMap[doc.id] = doc.data();
                });
                allTeamData = teamDataMap;
                renderApp();
            });

            // 4. Subscribe to Alliance Ledger (Public Data)
            const ledgerCollectionRef = collection(db, `${PUBLIC_DATA_PATH}/alliance_ledger`);
            const unsubscribeLedger = onSnapshot(ledgerCollectionRef, (snapshot) => {
                ledgerItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                ledgerItems.sort((a, b) => (a.id > b.id) ? 1 : -1); // Sort by ID (creation time)
                renderApp();
            });

            return () => {
                unsubscribeWeights();
                unsubscribeTeams();
                unsubscribeLedger();
            };
        };

        const initializeFirebase = async () => {
            if (!__firebase_config) {
                console.error("Firebase config is missing.");
                return;
            }

            try {
                setLogLevel('debug');
                const app = initializeApp(__firebase_config);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // CRITICAL FIX: setPersistence must be called with a persistence type
                await setPersistence(auth, browserLocalPersistence); 

                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        try {
                            if (__initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (e) {
                            console.error("Auth sign in failed:", e);
                        }
                    }
                    userId = auth.currentUser?.uid || generateUniqueId();
                    isAuthReady = true;

                    // Data seeding runs once after auth is ready
                    await seedInitialData();

                    // Listeners start after auth is ready
                    subscribeToData();
                    renderApp();
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        };

        // --- PUBLIC API FOR WINDOW (Event handlers) ---

        window.app = {
            handleScoreChange,
            handleWeightChange,
            handleEvidenceFactorChange,
            handleLedgerEdit,
            handleLedgerAdd: (area, action, kpi, timeline) => handleLedgerAdd(area, action, kpi, timeline),
            handleLedgerDelete,
            handleTeamClaim,
            setActiveTab: (tab) => {
                activeTab = tab;
                renderApp();
            },
            // Wrapper to expose LLM function to onclick handler
            generateImprovementPlanWrapper: (pillar, lowScoresString) => {
                try {
                    const lowScores = JSON.parse(lowScoresString);
                    generateImprovementPlan(pillar, lowScores);
                } catch (e) {
                    console.error("Error parsing low scores:", e);
                    llmStatus = { isLoading: false, error: "Data error: Cannot generate plan.", targetPillar: pillar };
                    renderApp();
                }
            }
        };

        // --- Start Application ---
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Team Selection Modal (RETAINED IN HTML BUT HIDDEN BY JS) -->
    <div id="team-selection-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
            <i data-lucide="log-in" class="h-10 w-10 mx-auto mb-4" style="color: ${LEAP_COLORS.BLUE};"></i>
            <h2 class="text-2xl font-bold mb-3" style="color: ${LEAP_COLORS.BLUE};">Welcome to the Scoreboard!</h2>
            <p class="text-gray-700 mb-6">Please select your role to begin.</p>
            
            <div class="mb-4">
                <label for="team-list" class="block text-left text-sm font-medium text-gray-700 mb-1">Select your team:</label>
                <select id="team-list" class="w-full p-3 border-2 rounded-lg text-lg focus:ring-4 transition" style="border-color: ${LEAP_COLORS.BLUE};"></select>
            </div>
            
            <button id="select-team-button" class="w-full py-3 text-lg font-semibold rounded-lg text-white transition duration-300 shadow-md hover:shadow-lg mb-3" style="background-color: ${LEAP_COLORS.BLUE};">
                <i data-lucide="check-circle" class="inline h-5 w-5 mr-2 mb-1"></i>
                Claim Team Role
            </button>

            <button id="login-trainer-button" class="w-full py-3 text-lg font-semibold rounded-lg text-gray-700 border-2 transition duration-300 shadow-sm hover:shadow-md" style="border-color: ${LEAP_COLORS.GREY};">
                <i data-lucide="users" class="inline h-5 w-5 mr-2 mb-1"></i>
                Login as Trainer (Read-Only)
            </button>
        </div>
    </div>

    <!-- Header -->
    <header class="py-4 shadow-lg" style="background-color: ${LEAP_COLORS.BLUE};">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-white mb-3 sm:mb-0">
                Strategic Alliance Scoreboard
            </h1>
            <div id="user-status"></div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="shadow-md bg-white">
        <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
            <div id="nav-tabs" class="flex justify-start space-x-1 sm:space-x-4">
                <!-- Tabs rendered here by renderApp -->
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div id="main-content" class="px-4 sm:px-0">
            <!-- Content for active tab -->
            <div id="leaderboard-content" class="tab-content"></div>
            <div id="behaviors-content" class="tab-content hidden"></div>
            <div id="settings-content" class="tab-content hidden"></div>
            <div id="ledger-content" class="tab-content hidden"></div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="w-full py-3 mt-10 text-center" style="background-color: #F3F4F6;">
        <p class="text-sm italic" style="color: ${LEAP_COLORS.GREY};">
            LeapToSuccess | Transforming Talent into Performance
        </p>
    </footer>

</body>
</html>
